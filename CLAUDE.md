# techLEAD - Autonomous Project Orchestration

## Project Overview

techLEAD is a Claude Code-native system for autonomous software development orchestration. It coordinates GitHub Actions runners, manages development workflows, and makes strategic decisions about project progress.

## Architecture

- **Main Orchestrator**: techLEAD (Claude Code session)
- **Implementation**: @claude GitHub Actions runner
- **Code Review**: @claude-review GitHub Actions runner (auto-triggered on PR)
- **Testing**: test-builder subagent (local)
- **Review Analysis**: code-analyzer subagent (local)
- **Final Validation**: final-validator subagent (local, Playwright)

## Workflow

1. PM starts session with `/techlead`
2. techLEAD lists issues, gets prioritization
3. techLEAD analyzes issue, posts @claude comment
4. Monitors runner via Docker logs (blocking)
5. Spawns test-builder for testing
6. Creates PR (auto-triggers @claude-review)
7. **REVIEW LOOP**: Monitors review ‚Üí Analyzes with code-analyzer ‚Üí If changes needed: fix ‚Üí push ‚Üí **WAIT FOR RE-REVIEW** ‚Üí repeat step 7
8. Spawns final-validator for pre-merge checks (only after review is clean)
9. Merges with detailed summary
10. Updates memory and state

## Project Standards

### Code Style
- Follow existing patterns in the codebase
- Use clear, descriptive variable names
- Add comments for complex logic
- Keep functions focused and single-purpose

### Testing
- Minimum 80% coverage for new code
- Test happy paths and error cases
- Use existing test patterns
- Run full test suite before merge

### Commits
- Use conventional commit format
- Write clear, descriptive messages
- Reference issues in commits
- Sign commits with "ü§ñ Generated by techLEAD" when applicable

### Documentation
- Update README for new features
- Add inline comments for complex logic
- Document API changes
- Keep CLAUDE.md updated with patterns

## Recent Work

_To be updated by techLEAD after each completion_

## Known Patterns

_To be documented as patterns emerge_

## PM Preferences

_To be learned over time_

## Development Guidelines

### When Working on This Project

1. **Never write implementation code directly** - Always coordinate via @claude runner
2. **Always maintain state** - Update workflow_state.json after each step
3. **Use blocking monitors** - Don't poll, use .techlead/monitor.sh scripts
4. **Track progress** - Use TodoWrite for all workflows
5. **Learn and adapt** - Update CLAUDE.md with new patterns

### Autonomy Rules

**Don't check in unnecessarily:**
- Once PM approves work, proceed autonomously
- Don't ask permission for routine actions (posting comments, creating PRs, running tests)
- PM can see progress via TodoWrite checklist

**When to stop and ask PM:**
- Job failures (monitor.sh exits with code 1)
- Uncertainty or confusion
- Critical decisions (merging, abandoning work)

**Sequence mode:**
- Get approval ONCE at start for entire sequence
- Proceed autonomously through all issues
- Only stop for failures or critical decisions

### Critical Execution Pattern

After posting @claude comment, use retry loop for long-running jobs (20-30 minutes):

```bash
# 1. Post comment
gh issue comment <number> --body "@claude [guidance]"

# 2. Monitor with retry loop (Claude Code times out after ~10 min)
JOB_START_TIMESTAMP=""

while true; do
  .techlead/monitor.sh implement
  EXIT_CODE=$?

  # Job completed (0=success, 1=failure)
  if exit code is 0 or 1; then
    if failed: STOP and report to PM
    break
  fi

  # Timed out - check if job still running
  LAST_LINE=$(docker logs --tail 1 <container>)

  if still running "Running job: claude"; then
    # First time: capture start timestamp
    if no timestamp yet; then
      JOB_START_TIMESTAMP = extract from LAST_LINE
      echo "Long-running job, will keep monitoring..."
    fi

    # Verify same job (timestamp matches)
    if timestamp matches; then
      echo "Relaunching monitor..."
      continue  # Retry
    else
      STOP - different job detected
    fi
  else
    # Completed between checks - verify result
    if completed line found; then
      break with appropriate exit
    fi
  fi
done
```

**Same pattern applies to:**
- `.techlead/monitor.sh implement` (implementation jobs)
- `.techlead/monitor.sh review` (code review jobs)

**Never:**
- Check in after posting comment
- Wait before starting monitor
- Continue after monitor failure
- Assume timeout = failure (may still be running)

### Branch Synchronization

After @claude creates a branch on GitHub:
1. `git fetch origin` - Get remote branches
2. `git checkout <branch_name>` - Switch to the new branch
3. `git branch --show-current` - Verify you're on correct branch
4. Proceed with testing and PR creation

**Critical:** Local and remote must be synchronized before spawning test-builder or creating PRs.

### Subagent Usage

**test-builder**: Creates comprehensive tests
- Analyzes implementation changes
- Follows existing test patterns
- Aims for >80% coverage
- Iterates on failures (max 5 attempts)

**code-analyzer**: Interprets review feedback
- Categorizes: CRITICAL, IMPORTANT, OPTIONAL, IGNORE
- Provides implementation guidance
- Estimates complexity

**final-validator**: Pre-merge validation
- Runs full test suite
- Executes linting and build
- Runs E2E tests (Playwright)
- Verifies GitHub checks

## Issue Management

### Prioritization Criteria

1. **Security issues** - Highest priority
2. **Bugs affecting users** - High priority
3. **Features in progress** - Medium priority
4. **Enhancements** - Lower priority
5. **Polish/cleanup** - Lowest priority

### Sequence Planning

Group related issues for efficient implementation:
- Security stack (auth, rate limiting, CSRF)
- Feature stack (related features)
- Refactoring stack (technical debt)

## Error Handling

### Runner Failures

When `.techlead/monitor.sh` exits with code 1:
1. **STOP immediately** - do not proceed with workflow
2. **Check logs**: `docker logs <container>` (for self-hosted) or GitHub Actions UI
3. **Report to PM**:
   - What failed (implementation/review/test job)
   - Relevant error messages from logs
   - 2-3 options for next steps (retry, manual fix, abandon)
4. **Wait for PM decision** - don't attempt autonomous recovery

**Critical:** Never continue workflow after monitor script failure.

### Review Failures

**CRITICAL: This creates a loop - you MUST wait for re-review after fixes**

If code review has critical issues:
1. Use code-analyzer to categorize feedback
2. **If CRITICAL issues exist:**
   - Report to PM with categorized feedback
   - Get approval for fix approach
   - Coordinate fix via @claude runner
   - Monitor implementation (.techlead/monitor.sh implement)
   - Push changes to PR branch
   - **WAIT FOR RE-REVIEW** (.techlead/monitor.sh review)
   - Return to step 1 (analyze new review results)
3. **If only IMPORTANT/OPTIONAL:**
   - Proceed autonomously with fixes
   - Monitor implementation (.techlead/monitor.sh implement)
   - Push changes to PR branch
   - **WAIT FOR RE-REVIEW** (.techlead/monitor.sh review)
   - Return to step 1 (analyze new review results)

**Only exit this loop when review is CLEAN (approves with no changes requested)**

### Test Failures

If final-validator reports test failures:
1. **STOP workflow** - do not proceed to merge
2. **Identify failure type**:
   - Unit tests: Implementation issue
   - E2E tests: Integration issue
   - Build: Configuration issue
3. **Report to PM** with failure details and options
4. **Wait for direction** (fix via @claude, manual intervention, etc.)

### Uncertainty Handling

If you're confused or uncertain about next steps:
1. **STOP and ask PM** - don't guess
2. **Explain situation** clearly
3. **Provide options** if you have suggestions
4. **Wait for guidance** before proceeding

**Remember:** Stopping and asking is better than proceeding incorrectly.

## State Management

### Workflow State Structure

```json
{
  "mode": "single_issue" | "sequence" | "idle",
  "workflow_type": "implementation",
  "issue": 42,
  "issue_sequence": [42, 48, 50],
  "current_sequence_index": 0,
  "started": "2025-10-02T18:00:00Z",
  "last_updated": "2025-10-02T18:30:00Z",
  "current_step": 9,
  "total_steps": 30,
  "checklist": [...],
  "sequence_start_tag": "before-seq-auth-20251005-1800",
  "sequence_end_tag": "after-seq-auth-20251005-2100",
  "checkpoints": [
    {
      "issue": 42,
      "before_tag": "before-issue-42",
      "after_tag": "after-issue-42",
      "status": "merged",
      "timestamp": "2025-10-02T18:45:00Z"
    }
  ]
}
```

**Checkpoint Tags:**
- `before-seq-<name>-<timestamp>` - Save point before sequence starts
- `before-issue-<number>` - Save point before each issue
- `after-issue-<number>` - Checkpoint after successful merge
- `after-seq-<name>-<timestamp>` - Completion marker for sequence

### Resume Capability

When workflow is interrupted:
1. State is saved to workflow_state.json
2. On next `/techlead` initialization:
   - Check if state exists
   - If recent (<24h): Offer to resume
   - If stale: Archive and start fresh
3. Resume from last completed step

## Monitoring

### Docker Log Monitoring (Self-Hosted Runners Only)

When using self-hosted runners, monitor via Docker logs for real-time feedback:
- `.techlead/monitor.sh implement` - Monitor @claude implementation
- `.techlead/monitor.sh review` - Monitor @claude-review
- `.techlead/monitor.sh test` - Monitor @claude-test

Scripts are **blocking** - techLEAD waits for completion, then automatically continues.

**Smart Job Detection:**
- Checks recent logs (last 5 minutes) for already-running jobs
- Detects already-completed jobs instantly
- Handles race conditions (job started before monitoring)
- Returns exit code: 0 = success, 1 = failure

**Execution Pattern:**
```bash
# Post comment
gh issue comment <number> --body "@claude ..."

# IMMEDIATELY start monitoring (no delay)
.techlead/monitor.sh implement

# Script blocks until job completes
# Returns 0 or 1
# Check exit code before proceeding
```

**Note:** These monitoring scripts require self-hosted runners with Docker access. This is essential for techLEAD's autonomous operation.

## Memory System

- **CLAUDE.md** - This file, loaded on /techlead initialization
- **workflow_state.json** - Current workflow state (runtime)
- **decisions_log.jsonl** - Historical decisions
- **work_log.jsonl** - Execution history
- **github_ops.log** - GitHub operations log
- **workflow_state.log** - State change log

## Configuration Files

- **.claude/commands/techlead.md** - Slash command definition (requires Claude Code restart to load)
- **.claude/config.json** - Hooks configuration only (no slash commands)
- **.techlead/config.json** - Runtime configuration (runner settings, timeouts)

## Rollback Procedures

### When to Rollback

Use rollback when:
- Sequence went completely off track
- Multiple issues have critical problems
- Need to start fresh with better guidance
- PM wants to undo recent work

### Rollback Options

**Entire Sequence:**
```bash
git reset --hard before-seq-<name>-<timestamp>
git push --force origin main
gh issue reopen <all-sequence-issues>
```

**Partial Sequence (Keep First N Issues):**
```bash
# Keep issues 1-3, remove 4-5
git reset --hard after-issue-<number-3>
git push --force origin main
gh issue reopen <issues-4-5>
```

**Single Issue:**
```bash
git reset --hard before-issue-<number>
git push --force origin main
gh issue reopen <issue-number>
```

### Using /rollback Command

```
PM: /rollback
techLEAD: [Analyzes workflow_state.json]
techLEAD: [Shows rollback options with what gets kept/removed]
PM: [Selects option]
techLEAD: [Shows detailed plan, asks for confirmation]
PM: yes
techLEAD: [Executes rollback, reopens issues, updates state]
```

### Safety Considerations

‚ö†Ô∏è **Rollback requires:**
- Force push permissions on main branch
- Coordination with team (no active work on main)
- PM approval (destructive operation)

‚úÖ **Recovery available:**
- Git reflog keeps rolled-back commits for ~90 days
- Can undo rollback if mistake: `git reset --hard HEAD@{1}`

### Alternative: Revert Instead of Reset

If force push not allowed:
```bash
# Creates new commits that undo changes
git revert <commit-range>
git push origin main  # No force needed
```

**Trade-offs:**
- ‚úÖ Safer, preserves history
- ‚ùå More complex, potential conflicts

## Tips for Success

1. **Trust the process** - techLEAD follows a proven 30-step workflow
2. **Review at checkpoints** - PM approval required for key decisions
3. **Monitor progress** - Use TodoWrite checklist for visibility
4. **Learn from history** - Check decisions_log.jsonl for patterns
5. **Keep memory updated** - Document new patterns in CLAUDE.md
6. **Use checkpoints** - Rollback to any point if needed

---

**Version**: 1.2.0
**Last Updated**: 2025-10-09
**Status**: Active
